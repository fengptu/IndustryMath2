<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>บทเรียนการอินทิเกรตและแบบทดสอบ</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            line-height: 1.6;
            margin: 20px;
            background-color: #f4f4f4;
        }
        .container {
            max-width: 800px;
            margin: auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        h1, h2, h3 {
            color: #333;
        }
        .latex-formula {
            display: block;
            text-align: center;
            margin: 20px 0;
            font-size: 1.5em;
        }
        /* Login Form */
        #login-form {
            display: flex;
            flex-direction: column;
            gap: 10px;
            padding: 20px;
            background-color: #e9e9e9;
            border-radius: 8px;
        }
        #login-form input {
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
        #login-form button {
            padding: 10px;
            background-color: #0d6efd;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
        }
        #login-form button:hover {
            background-color: #0b5ed7;
        }

        /* User Info Section */
        #user-info {
            display: none;
            text-align: center;
            margin-bottom: 20px;
        }
        #user-info #logout-btn {
            background-color: #dc3545;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
        }

        /* Quiz Styles */
        .quiz-container {
            margin-top: 30px;
            display: none; /* ซ่อนไว้ก่อน */
        }
        .question-container {
            background-color: #e9e9e9;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none; /* ซ่อนทุกข้อไว้ก่อน */
        }
        .options-list {
            list-style-type: none;
            padding: 0;
        }
        .options-list li {
            margin-bottom: 10px;
        }
        .options-list label {
            cursor: pointer;
            display: block;
            padding: 10px;
            background-color: #fff;
            border: 1px solid #ddd;
            border-radius: 4px;
            transition: background-color 0.3s;
        }
        .options-list label:hover {
            background-color: #f1f1f1;
        }
        .options-list input[type="radio"] {
            margin-right: 10px;
        }
        .nav-button {
            padding: 10px 20px;
            background-color: #0d6efd;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            margin-top: 15px;
        }
        .nav-button:hover {
            background-color: #0b5ed7;
        }
        
        /* Results Styles */
        .results-container {
            display: none;
            background-color: #fff3cd;
            padding: 20px;
            border-radius: 8px;
            border: 1px solid #ffecb5;
        }
        .result-item {
            padding: 10px;
            border-bottom: 1px solid #ddd;
        }
        .result-item.correct {
            color: #0f5132;
        }
        .result-item.incorrect {
            color: #842029;
        }
        .summary {
            font-size: 1.5em;
            text-align: center;
            margin-bottom: 20px;
        }
        .summary-score {
            font-size: 2em;
            font-weight: bold;
            color: #198754;
        }
    </style>
    <script type="text/javascript" async
        src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/MathJax.js?config=TeX-MML-AM_CHTML">
    </script>
    <script type="text/x-mathjax-config">
        MathJax.Hub.Config({
            tex2jax: {inlineMath: [['$','$'], ['\\(','\\)']]},
            "HTML-CSS": { linebreaks: { automatic: true } },
            "SVG": { linebreaks: { automatic: true } }
        });
    </script>
</head>
<body>

<div class="container">
    <h1>บทเรียน: การอินทิเกรตเบื้องต้น</h1>
    <p>สวัสดีเพื่อน! วันนี้เราจะมาเรียนรู้เรื่องการอินทิเกรต (Integration) กันนะ...</p>
</div>

<div class="container">
    <h2>แบบทดสอบ: การอินทิเกรต</h2>
    <p>แบบทดสอบมีทั้งหมด 5 ข้อ เมื่อทำครบทุกข้อจะแสดงผลลัพธ์ให้ทราบครับ</p>

    <div id="login-section">
        <h3>เข้าสู่ระบบ</h3>
        <form id="login-form">
            <input type="text" id="username" placeholder="ชื่อผู้ใช้" required>
            <input type="password" id="password" placeholder="รหัสผ่าน" required>
            <button type="submit">เข้าสู่ระบบ</button>
        </form>
        <p style="text-align: center; margin-top: 10px;">
            ถ้าคุณยังไม่มีบัญชี ให้ใส่ชื่อผู้ใช้และรหัสผ่านที่คุณต้องการเพื่อสร้างบัญชีใหม่
        </p>
    </div>

    <div id="user-info">
        <p>ยินดีต้อนรับ, <b id="username-display"></b>!</p>
        <p>คะแนนสูงสุดของคุณ: <span id="high-score-display">0</span>/5</p>
        <button id="logout-btn">ออกจากระบบ</button>
        <button id="start-quiz-btn" class="nav-button">เริ่มทำแบบทดสอบ</button>
    </div>

    <div class="quiz-container" id="quiz-container">
        </div>

    <div class="results-container" id="results">
        <h3 class="summary">สรุปผลการทดสอบ</h3>
        <div id="score-display" class="summary"></div>
        <div id="results-list"></div>
    </div>
</div>

<script>
    // --- Quiz Data and Variables ---
    const allQuizData = [
        // Indefinite Integrals (10 questions)
        { id: 'q1', question: 'จงหาค่าของอินทิกรัลไม่จำกัดเขต: $$ \\int (3x^2 + 4x - 5) \\,dx $$', options: { 'a': 'ก. $x^3 + 2x^2 - 5x + C$', 'b': 'ข. $3x^3 + 4x^2 - 5x + C$', 'c': 'ค. $6x + 4$', 'd': 'ง. $x^3 + 2x^2 - 5x$' }, correct: 'a', rationale: '<b>เหตุผล:</b> ใช้กฎการอินทิเกรตพหุนาม: $\\int x^n \\,dx = \\frac{x^{n+1}}{n+1} + C$' },
        { id: 'q2', question: 'จงหาค่าของอินทิกรัลไม่จำกัดเขต: $$ \\int (\\sqrt{x} + \\frac{1}{\\sqrt{x}}) \\,dx $$', options: { 'a': 'ก. $x^{3/2} - x^{1/2} + C$', 'b': 'ข. $\\frac{2}{3}x^{3/2} + 2x^{1/2} + C$', 'c': 'ค. $\\frac{1}{2\\sqrt{x}} - \\frac{1}{2x\\sqrt{x}} + C$', 'd': 'ง. $\\frac{2}{3}x^{3/2} + x^{-1/2} + C$' }, correct: 'b', rationale: '<b>เหตุผล:</b> เขียน $\\sqrt{x}$ เป็น $x^{1/2}$ และ $\\frac{1}{\\sqrt{x}}$ เป็น $x^{-1/2}$ แล้วอินทิเกรตทีละพจน์' },
        { id: 'q3', question: 'จงหาค่าของอินทิกรัลไม่จำกัดเขต: $$ \\int e^{2x} \\,dx $$', options: { 'a': 'ก. $e^{2x} + C$', 'b': 'ข. $2e^{2x} + C$', 'c': 'ค. $\\frac{1}{2}e^{2x} + C$', 'd': 'ง. $e^{2x^2} + C$' }, correct: 'c', rationale: '<b>เหตุผล:</b> ใช้กฎการอินทิเกรต $ \\int e^{ax} \\,dx = \\frac{1}{a}e^{ax} + C $' },
        { id: 'q4', question: 'จงหาค่าของอินทิกรัลไม่จำกัดเขต: $$ \\int \\cos(3x) \\,dx $$', options: { 'a': 'ก. $3\\sin(3x) + C$', 'b': 'ข. $-\\sin(3x) + C$', 'c': 'ค. $\\frac{1}{3}\\sin(3x) + C$', 'd': 'ง. $-\\frac{1}{3}\\sin(3x) + C$' }, correct: 'c', rationale: '<b>เหตุผล:</b> ใช้กฎการอินทิเกรต $ \\int \\cos(ax) \\,dx = \\frac{1}{a}\\sin(ax) + C $' },
        { id: 'q5', question: 'จงหาค่าของอินทิกรัลไม่จำกัดเขต: $$ \\int (x^2 + 1)^2 \\,dx $$', options: { 'a': 'ก. $\\frac{x^5}{5} + \\frac{2x^3}{3} + x + C$', 'b': 'ข. $(\\frac{x^3}{3} + x)^2 + C$', 'c': 'ค. $\\frac{(x^2+1)^3}{3} + C$', 'd': 'ง. $(x^2+1)(2x) + C$' }, correct: 'a', rationale: '<b>เหตุผล:</b> กระจายพจน์ก่อนอินทิเกรต: $(x^2+1)^2 = x^4 + 2x^2 + 1$' },
        { id: 'q6', question: 'จงหาค่าของอินทิกรัลไม่จำกัดเขต: $$ \\int \\frac{1}{x^2} \\,dx $$', options: { 'a': 'ก. $\\ln|x^2| + C$', 'b': 'ข. $x^{-1} + C$', 'c': 'ค. $-x^{-1} + C$', 'd': 'ง. $-x^{-3} + C$' }, correct: 'c', rationale: '<b>เหตุผล:</b> เขียน $\\frac{1}{x^2}$ เป็น $x^{-2}$ แล้วอินทิเกรตตามกฎ: $\\frac{x^{-1}}{-1} + C$' },
        { id: 'q7', question: 'จงหาค่าของอินทิกรัลไม่จำกัดเขต: $$ \\int 5 \\,dx $$', options: { 'a': 'ก. $5x + C$', 'b': 'ข. $5 + C$', 'c': 'ค. $0$', 'd': 'ง. $\\frac{5x^2}{2} + C$' }, correct: 'a', rationale: '<b>เหตุผล:</b> อินทิกรัลของค่าคงที่ $k$ คือ $kx+C$' },
        { id: 'q8', question: 'จงหาค่าของอินทิกรัลไม่จำกัดเขต: $$ \\int \\frac{1}{\\sqrt{1-x^2}} \\,dx $$', options: { 'a': 'ก. $\\arcsin(x) + C$', 'b': 'ข. $\\arctan(x) + C$', 'c': 'ค. $\\sqrt{1-x^2} + C$', 'd': 'ง. $\\frac{1}{2}\\ln|1-x^2| + C$' }, correct: 'a', rationale: '<b>เหตุผล:</b> สูตรการอินทิเกรตพื้นฐานของ $\\arcsin(x)$ คือ $\\frac{1}{\\sqrt{1-x^2}}$' },
        { id: 'q9', question: 'จงหาค่าของอินทิกรัลไม่จำกัดเขต: $$ \\int \\sec^2(x) \\,dx $$', options: { 'a': 'ก. $\\tan(x) + C$', 'b': 'ข. $\\cot(x) + C$', 'c': 'ค. $\\sec(x)\\tan(x) + C$', 'd': 'ง. $2\\sec(x) + C$' }, correct: 'a', rationale: '<b>เหตุผล:</b> อินทิกรัลของ $\\sec^2(x)$ คือ $\\tan(x)$' },
        { id: 'q10', question: 'จงหาค่าของอินทิกรัลไม่จำกัดเขต: $$ \\int (2x+3)^5 \\,dx $$', options: { 'a': 'ก. $\\frac{(2x+3)^6}{6} + C$', 'b': 'ข. $\\frac{(2x+3)^6}{12} + C$', 'c': 'ค. $5(2x+3)^4 + C$', 'd': 'ง. $2(2x+3)^6 + C$' }, correct: 'b', rationale: '<b>เหตุผล:</b> ใช้กฎลูกโซ่แบบย้อนกลับ: $\\int (ax+b)^n \\,dx = \\frac{1}{a} \\frac{(ax+b)^{n+1}}{n+1} + C$' },
        // Definite Integrals (10 questions)
        { id: 'q11', question: 'จงหาค่าของอินทิกรัลจำกัดเขต: $$ \\int_0^2 (2x + 1) \\,dx $$', options: { 'a': 'ก. $6$', 'b': 'ข. $5$', 'c': 'ค. $3$', 'd': 'ง. $4$' }, correct: 'a', rationale: '<b>เหตุผล:</b> อินทิเกรตได้ $x^2+x$ แล้วแทนค่า: $(2^2+2) - (0^2+0) = 6$' },
        { id: 'q12', question: 'จงหาค่าของอินทิกรัลจำกัดเขต: $$ \\int_1^e \\frac{1}{x} \\,dx $$', options: { 'a': 'ก. $1$', 'b': 'ข. $\\ln(e)$', 'c': 'ค. $0$', 'd': 'ง. $-1$' }, correct: 'a', rationale: '<b>เหตุผล:</b> อินทิกรัลของ $1/x$ คือ $\\ln|x|$ แล้วแทนค่าขอบเขต: $\\ln(e) - \\ln(1) = 1-0=1$' },
        { id: 'q13', question: 'จงหาค่าของอินทิกรัลจำกัดเขต: $$ \\int_0^{\\pi} \\sin(x) \\,dx $$', options: { 'a': 'ก. $0$', 'b': 'ข. $1$', 'c': 'ค. $2$', 'd': 'ง. $-2$' }, correct: 'c', rationale: '<b>เหตุผล:</b> อินทิเกรตได้ $-\\cos(x)$ แล้วแทนค่า: $(-\\cos(\\pi)) - (-\\cos(0)) = (-(-1)) - (-1) = 1+1=2$' },
        { id: 'q14', question: 'จงหาค่าของอินทิกรัลจำกัดเขต: $$ \\int_1^2 x^3 \\,dx $$', options: { 'a': 'ก. $\\frac{15}{4}$', 'b': 'ข. $\\frac{1}{4}$', 'c': 'ค. $\\frac{7}{4}$', 'd': 'ง. $\\frac{3}{2}$' }, correct: 'a', rationale: '<b>เหตุผล:</b> อินทิเกรตได้ $\\frac{x^4}{4}$ แล้วแทนค่า: $\\frac{2^4}{4} - \\frac{1^4}{4} = \\frac{16-1}{4} = \\frac{15}{4}$' },
        { id: 'q15', question: 'จงหาค่าของอินทิกรัลจำกัดเขต: $$ \\int_0^1 e^x \\,dx $$', options: { 'a': 'ก. $e-1$', 'b': 'ข. $e$', 'c': 'ค. $1-e$', 'd': 'ง. $0$' }, correct: 'a', rationale: '<b>เหตุผล:</b> อินทิเกรตได้ $e^x$ แล้วแทนค่า: $e^1 - e^0 = e-1$' },
        { id: 'q16', question: 'จงหาค่าของอินทิกรัลจำกัดเขต: $$ \\int_{-1}^1 (x^3 - x) \\,dx $$', options: { 'a': 'ก. $0$', 'b': 'ข. $2$', 'c': 'ค. $-2$', 'd': 'ง. $1$' }, correct: 'a', rationale: '<b>เหตุผล:</b> อินทิกรัลของฟังก์ชันคี่ (odd function) ในช่วง $[-a, a]$ มีค่าเท่ากับ $0$' },
        { id: 'q17', question: 'จงหาค่าของอินทิกรัลจำกัดเขต: $$ \\int_0^4 \\sqrt{x} \\,dx $$', options: { 'a': 'ก. $4$', 'b': 'ข. $\\frac{16}{3}$', 'c': 'ค. $8$', 'd': 'ง. $\\frac{8}{3}$' }, correct: 'd', rationale: '<b>เหตุผล:</b> อินทิเกรต $x^{1/2}$ ได้ $\\frac{2}{3}x^{3/2}$ แล้วแทนค่า: $\\frac{2}{3}(4)^{3/2} - \\frac{2}{3}(0)^{3/2} = \\frac{2}{3}(8) = \\frac{16}{3}$' },
        { id: 'q18', question: 'จงหาค่าของอินทิกรัลจำกัดเขต: $$ \\int_0^\\pi \\cos(x) \\,dx $$', options: { 'a': 'ก. $0$', 'b': 'ข. $1$', 'c': 'ค. $-1$', 'd': 'ง. $2$' }, correct: 'a', rationale: '<b>เหตุผล:</b> อินทิเกรตได้ $\\sin(x)$ แล้วแทนค่า: $\\sin(\\pi) - \\sin(0) = 0-0=0$' },
        { id: 'q19', question: 'จงหาค่าของอินทิกรัลจำกัดเขต: $$ \\int_0^1 \\frac{1}{x+1} \\,dx $$', options: { 'a': 'ก. $\\ln(2)$', 'b': 'ข. $1$', 'c': 'ค. $\\ln(1)$', 'd': 'ง. $0$' }, correct: 'a', rationale: '<b>เหตุผล:</b> อินทิเกรตได้ $\\ln|x+1|$ แล้วแทนค่า: $\\ln(1+1) - \\ln(0+1) = \\ln(2)-\\ln(1) = \\ln(2)$' },
        { id: 'q20', question: 'จงหาค่าของอินทิกรัลจำกัดเขต: $$ \\int_1^3 (x^2 - 1) \\,dx $$', options: { 'a': 'ก. $\\frac{20}{3}$', 'b': 'ข. $\\frac{18}{3}$', 'c': 'ค. $8$', 'd': 'ง. $6$' }, correct: 'a', rationale: '<b>เหตุผล:</b> อินทิเกรตได้ $\\frac{x^3}{3}-x$ แล้วแทนค่า: $(\\frac{3^3}{3}-3) - (\\frac{1^3}{3}-1) = (9-3) - (-\\frac{2}{3}) = 6 + \\frac{2}{3} = \\frac{20}{3}$' }
    ];

    let randomizedQuizData = [];
    let userAnswers = {};
    const totalQuestionsToAsk = 5;
    let currentUser = null;
    let highScores = JSON.parse(localStorage.getItem('highScores')) || {};

    // --- Utility Functions ---
    function shuffleArray(array) {
        for (let i = array.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [array[i], array[j]] = [array[j], array[i]];
        }
    }

    // --- UI Display Functions ---
    function showSection(sectionId) {
        document.getElementById('login-section').style.display = 'none';
        document.getElementById('user-info').style.display = 'none';
        document.getElementById('quiz-container').style.display = 'none';
        document.getElementById('results').style.display = 'none';
        document.getElementById(sectionId).style.display = 'block';
    }

    function renderQuiz() {
        const quizContainer = document.getElementById('quiz-container');
        quizContainer.innerHTML = '';
        
        for (let i = 0; i < totalQuestionsToAsk; i++) {
            const questionData = randomizedQuizData[i];
            const questionElement = document.createElement('div');
            questionElement.className = 'question-container';
            questionElement.id = `question-${i + 1}`;
            
            let optionsHtml = '';
            for (const [key, value] of Object.entries(questionData.options)) {
                optionsHtml += `<li><label><input type="radio" name="q${i + 1}_option" value="${key}">${value}</label></li>`;
            }

            const buttonText = (i === totalQuestionsToAsk - 1) ? 'ดูผลลัพธ์' : 'ข้อต่อไป';

            questionElement.innerHTML = `
                <h3>คำถามที่ ${i + 1}</h3>
                <p>${questionData.question}</p>
                <ul class="options-list">
                    ${optionsHtml}
                </ul>
                <button class="nav-button" onclick="handleAnswer(${i + 1})">${buttonText}</button>
            `;
            quizContainer.appendChild(questionElement);
        }
        
        showSection('quiz-container');
        document.getElementById('question-1').style.display = 'block';
        MathJax.Hub.Queue(["Typeset", MathJax.Hub, quizContainer]);
    }

    function showResults() {
        showSection('results');

        let score = 0;
        const resultsList = document.getElementById('results-list');
        resultsList.innerHTML = '';

        for (let i = 0; i < totalQuestionsToAsk; i++) {
            const questionData = randomizedQuizData[i];
            const userAnswer = userAnswers[questionData.id];
            
            const isCorrect = userAnswer === questionData.correct;
            
            if (isCorrect) {
                score++;
            }
            
            const resultItem = document.createElement('div');
            resultItem.className = `result-item ${isCorrect ? 'correct' : 'incorrect'}`;
            
            const chosenOptionText = questionData.options[userAnswer] || 'ไม่ได้เลือก';
            const correctOptionText = questionData.options[questionData.correct] || 'ไม่พบคำตอบ';
            
            let resultHTML = `<b>คำถามที่ ${i + 1}:</b> ${isCorrect ? '✅ ถูกต้อง' : '❌ ผิด'}<br>`;
            resultHTML += `<b>คำตอบของคุณ:</b> ${chosenOptionText}<br>`;
            resultHTML += `<b>คำตอบที่ถูกต้องคือ:</b> ${correctOptionText}<br>`;
            resultHTML += `${questionData.rationale}`;

            resultItem.innerHTML = resultHTML;
            resultsList.appendChild(resultItem);
        }
        
        const scoreDisplay = document.getElementById('score-display');
        scoreDisplay.innerHTML = `คุณได้คะแนน <span class="summary-score">${score}</span>/${totalQuestionsToAsk} คะแนน`;
        
        updateHighScore(score);
        MathJax.Hub.Queue(["Typeset", MathJax.Hub, resultsContainer]);
    }

    // --- Quiz Logic ---
    function initializeQuiz() {
        const indefiniteQuestions = allQuizData.filter(q => q.id.startsWith('q'));
        const definiteQuestions = allQuizData.filter(q => q.id.startsWith('q'));
        
        shuffleArray(indefiniteQuestions);
        shuffleArray(definiteQuestions);

        const selectedQuestions = [
            ...indefiniteQuestions.slice(0, 2),
            ...definiteQuestions.slice(0, 3)
        ];
        
        shuffleArray(selectedQuestions);
        randomizedQuizData = selectedQuestions;
        userAnswers = {};
    }

    function handleAnswer(qNumber) {
        const questionData = randomizedQuizData[qNumber - 1];
        const selectedOption = document.querySelector(`input[name="q${qNumber}_option"]:checked`);
        
        if (!selectedOption) {
            alert('กรุณาเลือกคำตอบก่อนครับ');
            return;
        }

        userAnswers[questionData.id] = selectedOption.value;
        
        if (qNumber < totalQuestionsToAsk) {
            document.getElementById(`question-${qNumber}`).style.display = 'none';
            document.getElementById(`question-${qNumber + 1}`).style.display = 'block';
        } else {
            showResults();
        }
    }

    // --- Login/Score Management ---
    function updateUserInfo() {
        const usernameDisplay = document.getElementById('username-display');
        const highScoreDisplay = document.getElementById('high-score-display');
        usernameDisplay.textContent = currentUser;
        highScoreDisplay.textContent = highScores[currentUser] || 0;
        showSection('user-info');
    }

    function updateHighScore(newScore) {
        if (currentUser) {
            const currentHighScore = highScores[currentUser] || 0;
            if (newScore > currentHighScore) {
                highScores[currentUser] = newScore;
                localStorage.setItem('highScores', JSON.stringify(highScores));
                updateUserInfo();
            }
        }
    }

    function handleLogin(event) {
        event.preventDefault();
        const username = document.getElementById('username').value;
        const password = document.getElementById('password').value;

        // Simple login logic (just checks for non-empty fields)
        if (username && password) {
            currentUser = username;
            
            // If the user is new, initialize their high score to 0
            if (!highScores[currentUser]) {
                highScores[currentUser] = 0;
            }
            
            updateUserInfo();
            alert(`เข้าสู่ระบบสำเร็จ! ยินดีต้อนรับคุณ ${currentUser}`);
        } else {
            alert('กรุณาใส่ชื่อผู้ใช้และรหัสผ่าน');
        }
    }

    function handleLogout() {
        currentUser = null;
        document.getElementById('username').value = '';
        document.getElementById('password').value = '';
        showSection('login-section');
    }

    // --- Event Listeners and Initial Setup ---
    document.getElementById('login-form').addEventListener('submit', handleLogin);
    document.getElementById('logout-btn').addEventListener('click', handleLogout);
    document.getElementById('start-quiz-btn').addEventListener('click', () => {
        initializeQuiz();
        renderQuiz();
    });

    document.addEventListener('DOMContentLoaded', () => {
        showSection('login-section');
    });
</script>

</body>
</html>
